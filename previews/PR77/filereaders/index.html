<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>FileReaders · ClimaUtilities.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaUtilities.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaUtilities.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../climaartifacts/">ClimaArtifacts</a></li><li><a class="tocitem" href="../inputs/">Space and Time Inputs</a></li><li class="is-active"><a class="tocitem" href>FileReaders</a><ul class="internal"><li><a class="tocitem" href="#NCFileReaders"><span><code>NCFileReaders</code></span></a></li><li><a class="tocitem" href="#API"><span>API</span></a></li></ul></li><li><a class="tocitem" href="../datahandling/">DataHandling</a></li><li><a class="tocitem" href="../regridders/">Regridders</a></li><li><a class="tocitem" href="../outputpathgenerator/">OutputPathGenerator</a></li><li><a class="tocitem" href="../timemanager/">TimeManager</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>FileReaders</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>FileReaders</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimaUtilities.jl/blob/main/docs/src/filereaders.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="FileReaders"><a class="docs-heading-anchor" href="#FileReaders"><code>FileReaders</code></a><a id="FileReaders-1"></a><a class="docs-heading-anchor-permalink" href="#FileReaders" title="Permalink"></a></h1><p>Reading files is a common need for most scientific projects. This can come with a series of problems that have to be solved, from performance (accessing can be a very computationally expensive operation), to dealing with multiple files that are logically connected. The <code>FileReaders</code> provides an abstraction layer to decouple the scientific needs with the technical implementation so that file processing can be optimized and extended independently of the rest of the model.</p><p>At this point, the implemented <code>FileReaders</code> are always linked to a specific variable and they come with a caching system to avoid unnecessary reads.</p><p>Future extensions might include:</p><ul><li>dealing with multiple files containing the same variables (e.g. time series when the dates are split in different files);</li><li>doing chunked reads;</li><li>async reads.</li></ul><h2 id="NCFileReaders"><a class="docs-heading-anchor" href="#NCFileReaders"><code>NCFileReaders</code></a><a id="NCFileReaders-1"></a><a class="docs-heading-anchor-permalink" href="#NCFileReaders" title="Permalink"></a></h2><blockquote><p>This extension is loaded when loading <code>NCDatasets</code></p></blockquote><p>The only file reader currently implemented is the <code>NCFileReader</code>, used to read NetCDF files. Each <code>NCFileReader</code> is associated to one particular file and variable (but multiple <code>NCFileReader</code>s can share the same file).</p><p>Once created, <code>NCFileReader</code> is accessed with the <code>read(file_reader, date)</code> function, which returns the <code>Array</code> associated to given <code>date</code> (if available). The <code>date</code> can be omitted if the data is static.</p><p><code>NCFileReader</code>s implement two additional features: (1) optional preprocessing, and (2) cache reads. <code>NCFileReader</code>s can be created with a <code>preprocessing_func</code> keyword argument, function is applied to the read datasets when <code>read</code>ing. <code>preprocessing_func</code> should be a lightweight function, such as removing <code>NaN</code>s or changing units. Every time <code>read(file_reader, date)</code> is called, the <code>NCFileReader</code> checks if the <code>date</code> is currently stored in the cache. If yes, it just returns the value (without accessing the disk). If not, it reads and process the data and adds it to the cache. This uses a least-recently-used (LRU) cache implemented in <code>DataStructures</code>, which removes the least-recently-used data stored in the cache when its maximum size is reached (the default max size is 128).</p><p>It is good practice to always close the <code>NCFileReader</code>s when they are no longer needed. The function <code>close_all_ncfiles</code> closes all the ones that are currently open.</p><h3 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h3><p>Assume you have a file <code>era5_2000.nc</code>, which contains two variables <code>u</code> and <code>v</code>, defined for the year 2000.</p><pre><code class="language-julia hljs">import ClimaUtilities.FileReaders
import NCDatasets
# Loading NCDatasets automatically loads `NCFileReaders`

u_var = FileReaders.NCFileReader(&quot;era5_2000.nc&quot;, &quot;u&quot;)
# Change units for v
v_var = FileReaders.NCFileReader(&quot;era5_2000.nc&quot;, &quot;u&quot;, preprocess_func = x -&gt; 1000x)

dates = FileReaders.available_dates(u_var)
# dates is a vector of Dates.DateTime

first_date = dates[begin]

# The first time we call read, the file is accessed and read
u_array = FileReaders.read(u_var, first_date)
# As the name suggests, u_array is an Array

# All the other times, we access the cache, so no IO operation is involved
u_array_again = FileReaders.read(u_var, first_date)

close(u_var)
close(v_var)
# Alternatively: FileReaders.close_all_ncfiles()</code></pre><h2 id="API"><a class="docs-heading-anchor" href="#API">API</a><a id="API-1"></a><a class="docs-heading-anchor-permalink" href="#API" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="ClimaUtilities.FileReaders.NCFileReader" href="#ClimaUtilities.FileReaders.NCFileReader"><code>ClimaUtilities.FileReaders.NCFileReader</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">FileReaders.NCFileReader(
    file_path::AbstractString,
    varname::AbstractString;
    preprocess_func = identity,
    cache_max_size:Int = 128,
)</code></pre><p>A struct to efficiently read and process NetCDF files.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/NCFileReaderExt.jl#L65-L74">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaUtilities.FileReaders.read" href="#ClimaUtilities.FileReaders.read"><code>ClimaUtilities.FileReaders.read</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">read(file_reader::NCFileReader, date::Dates.DateTime)</code></pre><p>Read and preprocess the data at the given <code>date</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/NCFileReaderExt.jl#L171-L175">source</a></section><section><div><pre><code class="nohighlight hljs">read(file_reader::NCFileReader)</code></pre><p>Read and preprocess data (for static datasets).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/NCFileReaderExt.jl#L212-L216">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaUtilities.FileReaders.available_dates" href="#ClimaUtilities.FileReaders.available_dates"><code>ClimaUtilities.FileReaders.available_dates</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">available_dates(file_reader::NCFileReader)</code></pre><p>Returns the dates in the given file.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/NCFileReaderExt.jl#L203-L207">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaUtilities.FileReaders.close_all_ncfiles" href="#ClimaUtilities.FileReaders.close_all_ncfiles"><code>ClimaUtilities.FileReaders.close_all_ncfiles</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">close_all_ncfiles()</code></pre><p>Close all the <code>NCFileReader</code> currently open.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/NCFileReaderExt.jl#L158-L162">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Base.close" href="#Base.close"><code>Base.close</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">close(data_handler::DataHandler)</code></pre><p>Close any file associated to the given <code>data_handler</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/DataHandlingExt.jl#L199-L203">source</a></section><section><div><pre><code class="nohighlight hljs">close(time_varying_input::TimeVaryingInputs.AbstractTimeVaryingInput)</code></pre><p>Close files associated to the <code>time_varying_input</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/TimeVaryingInputsExt.jl#L266-L270">source</a></section><section><div><pre><code class="nohighlight hljs">close(time_varying_input::InterpolatingTimeVaryingInput23D)</code></pre><p>Close files associated to the <code>time_varying_input</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/TimeVaryingInputsExt.jl#L277-L281">source</a></section><section><div><pre><code class="nohighlight hljs">close(file_reader::NCFileReader)</code></pre><p>Close <code>NCFileReader</code>. If no other <code>NCFileReader</code> is using the same file, close the NetCDF file.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaUtilities.jl/blob/c376abe13b654e03ec0c403ece0fc096cb1ffdf5/ext/NCFileReaderExt.jl#L138-L142">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../inputs/">« Space and Time Inputs</a><a class="docs-footer-nextpage" href="../datahandling/">DataHandling »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Tuesday 30 July 2024 20:56">Tuesday 30 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
